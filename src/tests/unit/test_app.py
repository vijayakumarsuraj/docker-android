"""Unit test to test app."""
import os
from unittest import TestCase

import mock

from src import app


class TestApp(TestCase):
    """Unit test class to test other methods in the app."""

    def test_valid_env(self):
        key = 'ENV_1'
        os.environ[key] = 'test'
        app.get_or_raise(key)
        del os.environ[key]

    def test_invalid_env(self):
        with self.assertRaises(RuntimeError):
            app.get_or_raise('ENV_2')

    def test_valid_bool(self):
        self.assertEqual(app.convert_str_to_bool('True'), True)
        self.assertEqual(app.convert_str_to_bool('t'), True)
        self.assertEqual(app.convert_str_to_bool('1'), True)
        self.assertEqual(app.convert_str_to_bool('YES'), True)

    def test_invalid_bool(self):
        self.assertEqual(app.convert_str_to_bool(''), False)
        self.assertEqual(app.convert_str_to_bool('test'), False)

    def test_invalid_format(self):
        self.assertEqual(app.convert_str_to_bool(True), None)

    @mock.patch('src.app.prepare_avd')
    @mock.patch('subprocess.Popen')
    def test_run_with_appium(self, mocked_avd, mocked_subprocess):
        with mock.patch('src.app.appium_run') as mocked_appium:
            os.environ['AVD'] = str(False)
            os.environ['APPIUM'] = str(True)
            app.run()
            self.assertFalse(mocked_avd.called)
            self.assertFalse(mocked_subprocess.called)
            self.assertTrue(mocked_appium.called)

    @mock.patch('src.app.prepare_avd')
    @mock.patch('subprocess.Popen')
    def test_run_without_appium(self, mocked_avd, mocked_subprocess):
        with mock.patch('src.app.appium_run') as mocked_appium:
            os.environ['AVD'] = str(False)
            os.environ['APPIUM'] = str(False)
            app.run()
            self.assertFalse(mocked_avd.called)
            self.assertFalse(mocked_subprocess.called)
            self.assertFalse(mocked_appium.called)

    @mock.patch('src.app.appium_run')
    def test_run_with_avd(self, mocked_appium):
        with mock.patch('src.app.prepare_avd') as mocked_avd:
            with mock.patch('subprocess.Popen') as mocked_subprocess:
                os.environ['AVD'] = str(True)
                os.environ['APPIUM'] = str(False)
                app.run()
                self.assertTrue(mocked_avd.called)
                self.assertTrue(mocked_subprocess.called)
                self.assertFalse(mocked_appium.called)
                
    @mock.patch('src.app.appium_run')
    def test_run_without_avd(self, mocked_appium):
        with mock.patch('src.app.prepare_avd') as mocked_avd:
            with mock.patch('subprocess.Popen') as mocked_subprocess:
                os.environ['AVD'] = str(False)
                os.environ['APPIUM'] = str(False)
                app.run()
                self.assertFalse(mocked_avd.called)
                self.assertFalse(mocked_subprocess.called)
                self.assertFalse(mocked_appium.called)
                